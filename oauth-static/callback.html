<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>Notion認証中 - Raku Raku Notion</title>
</head>
<body>
    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var code = urlParams.get('code');
        var state = urlParams.get('state');
        var error = urlParams.get('error');

        // エラーまたはパラメータ不足の場合はエラーページへ
        if (error || !code || !state) {
            var errorMessage = error || 'パラメータが不足しています';
            window.location.replace('./error.html?reason=' + encodeURIComponent(errorMessage));
        }
        // 正常な場合は拡張機能にリダイレクト
        else {
            try {
                // stateからextension IDを抽出
                // state形式: base64(extensionId:randomToken)
                var decoded = atob(state);
                var parts = decoded.split(':');

                if (parts.length !== 2) {
                    throw new Error('Invalid state format');
                }

                var extensionId = parts[0];
                console.log('[OAuth Callback] Extracted extension ID:', extensionId);

                // 拡張機能にリダイレクト
                var extensionUrl = 'chrome-extension://' + extensionId + '/oauth-callback.html?code=' + encodeURIComponent(code) + '&state=' + encodeURIComponent(state);
                window.location.replace(extensionUrl);
            } catch (e) {
                console.error('[OAuth Callback] Failed to parse state:', e);
                window.location.replace('./error.html?reason=' + encodeURIComponent('stateパラメータの解析に失敗しました'));
            }
        }
    </script>
</body>
</html>
